<!DOCTYPE html>
<html>
<head>
    <title>Kindle Share</title>
</head>
<body>
    <div id="KindleSettingsPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-button,emby-input,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <h1 id="pageTitle">Kindle Share Configuration</h1>

                <form id="kindleConfigForm">
                    <!-- SMTP Settings -->
                    <h2 id="smtpSectionTitle" style="margin-top:1em;">SMTP Settings</h2>

                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="SmtpHost" label="SMTP Host" />
                        <div class="fieldDescription" id="smtpHostDesc">
                            The SMTP server of your email provider (e.g. smtp.gmail.com).
                        </div>
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="number" id="SmtpPort" label="SMTP Port" />
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="text" id="SmtpUser" label="Username" />
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="password" id="SmtpPassword" label="Password" />
                    </div>
                    <div class="inputContainer">
                        <input is="emby-input" type="email" id="SenderEmail" label="Sender E-Mail" />
                        <div class="fieldDescription" id="senderEmailDesc">
                            The sender email address. Leave empty to use the username as sender.
                        </div>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="UseSsl" />
                            <span id="useSslLabel">Use SSL/TLS</span>
                        </label>
                    </div>

                    <!-- OAuth2 Settings -->
                    <h2 id="oauthSectionTitle" style="margin-top:2em;">OAuth2 Settings</h2>

                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="UseOAuth2" />
                            <span id="useOAuth2Label">Use OAuth2 instead of password authentication</span>
                        </label>
                    </div>
                    <div id="oauthFields" style="display:none;">
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="OAuthClientId" label="OAuth2 Client ID" />
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" type="password" id="OAuthClientSecret" label="OAuth2 Client Secret" />
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" type="password" id="OAuthRefreshToken" label="OAuth2 Refresh Token" />
                        </div>
                    </div>

                    <button is="emby-button" type="submit" class="raised button-submit block" style="margin-top:2em;">
                        <span id="btnSaveText">Save</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var PLUGIN_ID = 'e3b2b4a1-1234-4567-89ab-cdef12345678';

        var i18n = {
            en: {
                pageTitle: 'Kindle Share Configuration',
                smtpSection: 'SMTP Settings',
                smtpHostDesc: 'The SMTP server of your email provider (e.g. smtp.gmail.com).',
                senderEmailDesc: 'The sender email address. Leave empty to use the username as sender.',
                useSsl: 'Use SSL/TLS',
                oauthSection: 'OAuth2 Settings',
                useOAuth2: 'Use OAuth2 instead of password authentication',
                save: 'Save'
            },
            de: {
                pageTitle: 'Kindle Share Konfiguration',
                smtpSection: 'SMTP Einstellungen',
                smtpHostDesc: 'Der SMTP-Server deines E-Mail-Anbieters (z.B. smtp.gmail.com).',
                senderEmailDesc: 'Die Absender-E-Mail-Adresse. Leer lassen, um den Benutzernamen als Absender zu verwenden.',
                useSsl: 'SSL/TLS nutzen',
                oauthSection: 'OAuth2 Einstellungen',
                useOAuth2: 'OAuth2 statt Passwort-Authentifizierung nutzen',
                save: 'Speichern'
            }
        };

        function getLang() {
            var lang = (navigator.language || 'en').substring(0, 2).toLowerCase();
            return i18n[lang] ? lang : 'en';
        }

        var page = document.querySelector('#KindleSettingsPage');
        console.log('[Kindle] Config page script running.');

        // i18n
        (function applyTranslations() {
            var t = i18n[getLang()];
            page.querySelector('#pageTitle').textContent = t.pageTitle;
            page.querySelector('#smtpSectionTitle').textContent = t.smtpSection;
            page.querySelector('#smtpHostDesc').textContent = t.smtpHostDesc;
            page.querySelector('#senderEmailDesc').textContent = t.senderEmailDesc;
            page.querySelector('#useSslLabel').textContent = t.useSsl;
            page.querySelector('#oauthSectionTitle').textContent = t.oauthSection;
            page.querySelector('#useOAuth2Label').textContent = t.useOAuth2;
            page.querySelector('#btnSaveText').textContent = t.save;
        })();

        // Toggle OAuth2 fields visibility
        function toggleOAuthFields() {
            var show = page.querySelector('#UseOAuth2').checked;
            page.querySelector('#oauthFields').style.display = show ? '' : 'none';
        }

        page.querySelector('#UseOAuth2').addEventListener('change', toggleOAuthFields);

        // Load config - called immediately and on page events
        function loadConfig() {
            console.log('[Kindle] Loading config...');
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(PLUGIN_ID).then(function (config) {
                console.log('[Kindle] Config loaded successfully.');
                page.querySelector('#SmtpHost').value = config.SmtpHost || '';
                page.querySelector('#SmtpPort').value = config.SmtpPort || 587;
                page.querySelector('#SmtpUser').value = config.SmtpUser || '';
                page.querySelector('#SmtpPassword').value = config.SmtpPassword || '';
                page.querySelector('#SenderEmail').value = config.SenderEmail || '';
                page.querySelector('#UseSsl').checked = config.UseSsl;
                page.querySelector('#UseOAuth2').checked = config.UseOAuth2;
                page.querySelector('#OAuthClientId').value = config.OAuthClientId || '';
                page.querySelector('#OAuthClientSecret').value = config.OAuthClientSecret || '';
                page.querySelector('#OAuthRefreshToken').value = config.OAuthRefreshToken || '';
                toggleOAuthFields();
                Dashboard.hideLoadingMsg();
            }).catch(function (err) {
                console.error('[Kindle] Config load failed:', err);
                Dashboard.hideLoadingMsg();
            });
        }

        // Load immediately (don't depend on any specific event)
        loadConfig();
        // Also listen for page events as fallback for re-navigation
        page.addEventListener('pageshow', loadConfig);
        page.addEventListener('viewshow', loadConfig);

        // Save config on form submit
        page.querySelector('#kindleConfigForm').addEventListener('submit', function (e) {
            e.preventDefault();
            console.log('[Kindle] Save triggered.');
            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(PLUGIN_ID).then(function (config) {
                config.SmtpHost = page.querySelector('#SmtpHost').value;
                config.SmtpPort = parseInt(page.querySelector('#SmtpPort').value, 10) || 587;
                config.SmtpUser = page.querySelector('#SmtpUser').value;
                config.SmtpPassword = page.querySelector('#SmtpPassword').value;
                config.SenderEmail = page.querySelector('#SenderEmail').value;
                config.UseSsl = page.querySelector('#UseSsl').checked;
                config.UseOAuth2 = page.querySelector('#UseOAuth2').checked;
                config.OAuthClientId = page.querySelector('#OAuthClientId').value;
                config.OAuthClientSecret = page.querySelector('#OAuthClientSecret').value;
                config.OAuthRefreshToken = page.querySelector('#OAuthRefreshToken').value;

                console.log('[Kindle] Sending config to server...');
                return ApiClient.updatePluginConfiguration(PLUGIN_ID, config);
            }).then(function (result) {
                console.log('[Kindle] Config saved successfully.');
                Dashboard.processPluginConfigurationUpdateResult(result);
            }).catch(function (err) {
                console.error('[Kindle] Save failed:', err);
                Dashboard.hideLoadingMsg();
                Dashboard.alert('Save failed. Check browser console for details.');
            });

            return false;
        });
    </script>
</body>
</html>
