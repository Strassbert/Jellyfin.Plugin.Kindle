<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>E-Book User Settings</title>
</head>
<body>
    <div id="KindleUserSettingsPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-button,emby-input">
        <div data-role="content">
            <div class="content-primary">
                <form id="KindleUserForm">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="UserKindleEmail">E-Book E-Mail</label>
                        <input id="UserKindleEmail" name="UserKindleEmail" type="email" is="emby-input" />
                        <div class="fieldDescription">
                            Books will be sent to this address.
                        </div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                    <details>
                        <summary style="cursor: pointer; font-weight: bold; list-style: none;">
                        &#709; Beispiel Kindle
                        </summary>
                            <p style="margin-top: 10px; padding-left: 15px;">
                                Um deine für Send to Kindle verwendete E-Mail-Adresse zu finden, wähle 
                                    <a href="https://www.amazon.de/hz/mycd/digital-console/contentlist/pdocs/dateDsc" target="_blank">
                                        Meine Inhalte und Geräte verwalten
                                    </a> 
                                &gt; Einstellungen &gt; Persönliche Dokumente Einstellungen.
                            </p>
                            <p style="margin-top: 10px; padding-left: 15px;">
                                Nur genehmigte E-Mail-Adressen können Dateien an deine Kindle-Bibliothek senden. Vergewissere dich vor dem Senden, dass das Konto, das du verwenden wirst, in deiner
                                    <a href="https://www.amazon.de/hz/mycd/preferences/myx#/home/settings/payment" target="_blank">
                                        E-Mail-Liste für genehmigte persönliche Dokumente
                                    </a> 
                                in deinen Einstellungen für persönliche Dokumente aufgeführt ist.
                            </p>
                    </details>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            function loadKindleUserEmail() {
                Dashboard.showLoadingMsg();
                var userId = ApiClient.getCurrentUserId();

                ApiClient.ajax({
                    type: 'GET',
                    url: ApiClient.getUrl('Kindle/UserEmail', { userId: userId }),
                    dataType: 'json'
                }).then(function (result) {
                    document.querySelector('#UserKindleEmail').value = result.email || '';
                    Dashboard.hideLoadingMsg();
                }).catch(function () {
                    Dashboard.hideLoadingMsg();
                });
            }

            // Load on all possible events + immediately
            document.querySelector('#KindleUserSettingsPage')
                .addEventListener('viewshow', loadKindleUserEmail);
            document.querySelector('#KindleUserSettingsPage')
                .addEventListener('pageshow', loadKindleUserEmail);

            // Also load immediately - events may have already fired before this script ran
            loadKindleUserEmail();

            document.querySelector('#KindleUserForm')
                .addEventListener('submit', function (e) {
                    Dashboard.showLoadingMsg();
                    var userId = ApiClient.getCurrentUserId();
                    var email = document.querySelector('#UserKindleEmail').value.trim();

                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('Kindle/UserEmail', { userId: userId, email: email })
                    }).then(function () {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('E-Book email saved.');
                    }).catch(function () {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save E-Book email.');
                    });

                    e.preventDefault();
                    return false;
                });
        </script>
    </div>
</body>
</html>
